###############################################################################
.SUFFIXES:                         # desativa regras implÃ­citas do GNU make

# â€” Ferramentas --------------------------------------------------------------
PREFIX   ?= arm-none-eabi-
CC       := $(PREFIX)gcc
MYCC     := ../../mycc              # seu compilador -> .s
QEMU     ?= qemu-system-arm
GDB      ?= gdb-multiarch
LDS      := linker.ld

CFLAGS    = -mcpu=arm7tdmi -marm -nostdlib -Og
LDFLAGS   = -T $(LDS)
QEMUFLAGS = -M virt -nographic -semihosting        # captura SWI 0x123456

# â€” 1)  .c  â†’  .s ------------------------------------------------------------
%.s : %.c $(MYCC)
	@echo "ğŸ›   [asm] $< â†’ $@"
	$(MYCC) -S $< > $@

# â€” 2)  .s  â†’  .elf ----------------------------------------------------------
%.elf : %.s $(LDS)
	@echo "ğŸ›   [link] $< â†’ $@"
	$(CC) $(CFLAGS) $< -o $@ $(LDFLAGS)

# â€” 3)  executa --------------------------------------------------------------
%.run : %.elf
	@echo "â–¶ï¸   Executando $< â€¦"
	@$(QEMU) $(QEMUFLAGS) -kernel $< ; echo "ğŸ“¤ exit=$$?"

# â€” 4)  depuraÃ§Ã£o (QEMU + GDB) ----------------------------------------------
%.gdb : %.elf
	@echo "ğŸ›   Debug: abrindo QEMU + GDB"
	@$(QEMU) $(QEMUFLAGS) -S -gdb tcp::1234 -kernel $< & \
	  qpid=$$! ; sleep 0.5 ; \
	  $(GDB) -q $< \
	    -ex "target remote :1234" \
        -ex "load" \
	    -ex "monitor system_reset" \
	    -ex "tui enable" ; \
	  kill $$qpid >/dev/null 2>&1 || true

# â€”â€“â€“â€“â€“ metas de conveniÃªncia â€”â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
# Arquivos .c passados na linha de comando, + os vindos via FILES=
FILES := $(basename $(filter %.c,$(MAKECMDGOALS))) $(FILES)

.PHONY: run gdb clean

run: $(addsuffix .run,$(FILES))
gdb: $(addsuffix .gdb,$(FILES))

# Evita que foo.c vire â€œtargetâ€ a construir
$(FILES:%=%.c):

clean:
	rm -f *.s *.elf
###############################################################################
